@startuml devices-management-domain-model

hide empty members
package Repository{
    interface Repository<Id, Entity>
}

package "Users management" as UsersManagement {
    interface UsersService <<Service>>
}

package "Devices management" {

    interface Device <<Aggregate Root>> {
        id: DeviceId
        name: String
        address: URL
        ~ executeAction(DeviceActionId, input: Any): (InvalidInputError | DeviceActionError | DeviceActionNotFound)?
    }

    enum DeviceStatus {
        Online
        Offline
    }

    interface DeviceGroup <<Aggregate Root>> {
        id: DeviceGroupId
        name: String
        ~addDeviceToGroup(DeviceId)
        ~removeDeviceFromGroup(DeviceId)
    }

    enum Type<T> {
        IntType<Int>
        DoubleType<Double>
        BooleanType<Boolean>
        ColorType<Color>
        StringType<String>
        VoidType<Void>
    }

    interface TypeConstraints<T> {
        validate(value: T): InvalidValueError?
    }

    struct Enum {
        values: Set<String>
    }

    struct IntRange {
        min: Int
        max: Int
    }

    struct DoubleRange {
        min: Double
        max: Double
    }

    struct None<T>
    note bottom of None
        None represents a simple
        type without constraints
    end note


    interface DeviceProperty<T> {
        name: String
        value: T
    }

    interface DeviceAction<T> {
        id: DeviceActionId
        name: String
        description: String?
        ~ execute(input: V): (InvalidInputError | DeviceActionError)?
    }

    interface DeviceEvent {
        name: String
    }

    ~interface DeviceRepository<DeviceId, Device> <<Repository>> {
    }
    ~interface DeviceGroupRepository<DeviceGroupId, DeviceGroup> <<Repository>> {
    }

    interface DeviceEventsSubscriber {
        deviceEventPublished(DeviceId, DeviceEvent)
    }

    interface DeviceStatusChangesSubscriber {
        deviceStatusChanged(DeviceId, DeviceStatus)
    }

    interface DevicesService <<Service>> {
        add(deviceUrl: URL): DeviceId | DeviceUnreachableError
        remove(DeviceId): DeviceNotFoundError?
        rename(DeviceId, String): DeviceNotFoundError?
        find(DeviceId): Device | DeviceNotFoundError
        getAllDevices(): Iterable<Device>
        executeAction(DeviceId, DeviceActionId, input: Any) : (InvalidInputError | DeviceActionError | DeviceActionNotFound | DeviceNotFound)?
        publishEvent(DeviceId, eventName: String): (DeviceNotFoundError | NotDeviceEventError)?
        subscribeForDeviceEvents(DeviceEventsSubscriber)
        unsubscribeForDeviceEvents(DeviceEventsSubscriber)
        subscribeForDeviceStatusChanges(DeviceStatusChangesSubscriber)
        unsubscribeForDeviceStatusChanges(DeviceStatusChangesSubscriber)
        addGroup(name: String): DeviceGroupId | DeviceGroupNameAlreadyInUseError
        removeGroup(DeviceGroupId): DeviceGroupNotFoundError?
        renameGroup(DeviceGroupId, String): (DeviceGroupNotFoundError | DeviceGroupNameAlreadyInUseError)?
        findGroup(DeviceGroupId): DeviceGroup | DeviceGroupNotFoundError
        getAllDeviceGroups(): Iterable<DeviceGroup>
        addDeviceToGroup(DeviceId, DeviceGroupId): (DeviceNotFoundError | DeviceGroupNotFoundError)?
        removeDeviceFromGroup(DeviceId, DeviceGroupId): (DeviceNotFoundError | DeviceGroupNotFoundError)?
    }

    note right of DevicesService
        Every method accepts a Token to be verified and
        so it can also return a InvalidTokenError
    end note

    ~interface DeviceFactory <<Factory>> {
        new(deviceUrl: URL): Device | DeviceUnreachableError
    }


    Device -l- DeviceStatus : "status >"
    Device "0..*   "  <--r--o "   0..*" DeviceGroup
    TypeConstraints "0..*" -- "1" Type : "type >"
    Enum -u-|> TypeConstraints : "<String>"
    IntRange -u-|> TypeConstraints : "<Int>"
    DoubleRange -u-|> TypeConstraints : "<Double>"
    None -u-|> TypeConstraints
    DeviceAction "0..*" -- "1" TypeConstraints : "inputTypeConstraint >"
    Device "1" *-- "0..*" DeviceProperty
    Device "1" *-- "0..*" DeviceAction
    <> Diamond
    DeviceProperty -r- Diamond : "or"
    Diamond "0..1" -r- "1" DeviceAction : "setter >"
    note on link
        DeviceProperty.Device == DeviceAction.Device
    end note
    Diamond "0..*" -- "1" TypeConstraints
    Device [name: String] -- "0..*" DeviceEvent
    DeviceGroupRepository -u-|> Repository.Repository
    DeviceGroupRepository o-- DeviceGroup
    DeviceRepository -u-|> Repository.Repository
    DeviceRepository o-- Device
    DevicesService --> DeviceRepository
    DevicesService --> DeviceGroupRepository
    DevicesService --> DeviceFactory
    DevicesService "1" --> "0..*" DeviceEventsSubscriber
    DevicesService "1" --> "0..*" DeviceStatusChangesSubscriber
    DevicesService -r-> UsersManagement.UsersService
}

@enduml
